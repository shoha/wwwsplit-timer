/**
 * The timer AngularJS component for wwwspl.it
 * @version v0.1.0 - 2013-10-11
 * @link http://wwwspl.it
 * @author James Shore <shore.james@gmail.com>
 */
angular.module("wwwsplit-timer.templates",["timer.tmpl"]),angular.module("timer.tmpl",[]).run(["$templateCache",function(a){a.put("timer.tmpl",'<div class="ng-scope" id="control_nav">\n  <button class="control" id="start" ng-click="start_timer()" ng-disabled="running || is_editing">\n    <i class="icon-play icon-2x icon-white"></i>\n  </button>\n  <button disabled="disabled" class="control" id="reset" ng-click="reset_timer()" ng-disabled="!(running || is_finished)">\n    <i class="icon-refresh icon-2x icon-white"></i>\n  </button>\n  <button disabled="disabled" class="control" id="split" ng-click="split()" ng-disabled="!running">\n    <i class="icon-forward icon-2x icon-white"></i>\n  </button>\n  <button disabled="disabled" class="control" id="unsplit" ng-click="unsplit()" ng-disabled="!running || current_split == current_run.splits[0]">\n    <i class="icon-backward icon-2x icon-white"></i>\n  </button>\n  <button style="display: none;" class="control" id="cancel_edit" ng-click="cancel_edit()" ng-disabled="running || run_editor_form.$invalid" ng-show="is_editing">\n    <i class="icon-ban-circle icon-2x icon-white"></i>\n  </button>\n</div>\n\n<div id=\'current_run\'>\n  <table class=\'table\' id=\'current_run_splits\' ng-class=\'{"table-hover": !running}\'>\n    <tr id=\'current_run_title\'>\n      <th colspan=\'2\'>\n        <h1>\n          {{current_run.title}} #{{current_run.attempts}}\n        </h1>\n        <h4 id=\'current_run_game_title\'>\n          <a ng-href=\'#/games/{{current_run.game.id}}\'>\n            {{current_run.game.title}}\n          </a>\n        </h4>\n      </th>\n    </tr>\n    <tr class=\'current_run_split\' ng-class=\'{active_split: split == current_split}\' ng-repeat=\'split in current_run.splits | split_count_limiter:current_split:max_shown_splits\'>\n      <td class=\'split_title\'>\n      {{split.title}}\n      </td>\n      <td class=\'split_time\' ng-class=\'{ahead: split.live_data.live_time < split.split_time, behind: split.live_data.live_time > split.split_time,\n      gained_time: split.live_data.segment_diff < 0, lost_time: split.live_data.segment_diff > 0 ,\n      unknown: split.live_data.live_time && !split.live_data.relative_time,\n      best: split.live_data.best_segment}\'>\n        <span>{{split.live_data.relative_time || split.live_data.live_time || split.split_time | milliseconds_to_HMS}}</span>\n      </td>\n    </tr>\n  </table>\n</div>\n\n<div class=\'text-right\' id=\'clock\'>\n  <h1 class=\'clock\'>\n    {{(elapsed_time | milliseconds_to_HMS) || \'\'}}\n  </h1>\n</div>\n\n'+"<div class='highchart' id='current_run_chart_data' ng-model='current_run_chart_series' ng-options='current_run_chart_options'></div>")}]),function(){angular.module("wwwsplit-timer",["wwwsplit-timer.templates"]).directive("timer",["$timeout",function(a){return{restrict:"C",scope:{current_run:"=ngModel",running:"=isRunning"},templateUrl:"timer.tmpl",link:function(b){var c,d,e,f;return b.running=!1,b.current_run_chart_series={name:"Teh Urn",showInLegend:!1,data:[]},b.current_run_chart_options={chart:{renderTo:"current_run_chart_data",type:"line",backgroundColor:"#333",borderColor:"#222"},colors:["white"],labels:{style:{color:"white"}},title:{floating:!0,style:{display:"none"}},xAxis:{title:{enabled:!1,text:null,style:{color:"white"}},labels:{enabled:!1,style:{color:"white"}}},yAxis:{title:{text:null,style:{color:"white"}},labels:{enabled:!1,style:{color:"white"}}},tooltip:{formatter:function(){return"<b>"+this.key+"</b><br/>"+this.y}},credits:{style:{color:"white"}},width:"100%"},c=function(a,c){var d,e,f;if(null==a.split_time)a.live_data.relative_time=null,a.live_data.segment_diff=null,0===c?(a.live_data.live_segment_time=a.live_data.live_time,a.live_data.segment_diff=null):a.live_data.live_segment_time=a.live_data.live_time-b.current_run.splits[c-1].live_data.live_time;else if(a.live_data.relative_time=a.live_data.live_time-a.split_time,0===c)a.live_data.live_segment_time=a.live_data.live_time,a.live_data.segment_diff=a.live_data.relative_time;else for(a.live_data.live_segment_time=a.live_data.live_time-b.current_run.splits[c-1].live_data.live_time,d=e=f=c-1;0>=f?0>=e:e>=0;d=0>=f?++e:--e)if(null!=b.current_run.splits[d].live_data.relative_time){a.live_data.segment_diff=a.live_data.relative_time-b.current_run.splits[d].live_data.relative_time;break}return a.live_data.best_segment=null==a.best_segment||a.best_segment>a.live_data.live_segment_time?!0:!1},d=function(){return b.elapsed_time=Date.now()-b.start_time},f=function(){return d(),b.timer_timeout_promise=a(f,25)},b.start_timer=function(){var c,d,e,g;if(b.current_run.splits.length){for(g=b.current_run.splits,d=0,e=g.length;e>d;d++)c=g[d],c.live_data={};return b.current_split=b.current_run.splits[0],a.cancel(b.timer_timeout_promise),b.start_time=Date.now(),b.current_run_chart_series.data=[],b.timer_timeout_promise=a(f,25),b.current_run.attempts++,b.running=!0,b.is_finished=!1,b.is_editing=!1}},e=function(){var a,c,d,e,f;if(b.current_run.splits){for(e=b.current_run.splits,f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push(delete a.live_data);return f}},b.reset_timer=function(){return a.cancel(b.timer_timeout_promise),e(),b.current_split=null,b.current_run_chart_series&&(b.current_run_chart_series.data=[]),b.running=!1,b.is_finished=!1,b.elapsed_time=null,b.start_time=null},b.poke_chart_options=function(){return b.current_run_chart_options.poke=!b.current_run_chart_options.poke},b.split=function(){return b.current_split.live_data={},b.current_split.live_data.live_time=b.elapsed_time,c(b.current_split,b.current_run.splits.indexOf(b.current_split)),null!=b.current_split.split_time&&b.current_run_chart_series.data.push({x:b.current_split.live_data.live_time/1e3,y:b.current_split.live_data.relative_time/1e3,name:b.current_split.title}),b.current_split===b.current_run.splits[b.current_run.splits.length-1]?(b.finish_run(),void 0):b.current_split=b.current_run.splits[b.current_run.splits.indexOf(b.current_split)+1]},b.unsplit=function(){return b.current_split=b.current_run.splits[b.current_run.splits.indexOf(b.current_split)-1],b.current_split.live_data={},null!=b.current_split.split_time?b.current_run_chart_series.data.pop():void 0},b.finish_run=function(){return a.cancel(b.timer_timeout_promise),b.current_split=null,b.running=!1,b.is_finished=!0}}}}]).filter("split_count_limiter",function(){return function(a,b,c){var d,e,f;return null==a?[]:null==c||c>a.length?a:b?(e=a.indexOf(b),e+c>a.length?a.slice(a.length-c,a.length):(f=Math.max(0,e-Math.floor(c/2)),d=Math.min(f+c,a.length),a.slice(f,d))):a.slice(0,c)}}).filter("milliseconds_to_HMS",function(){return function(a){var b,c,d,e,f;return null==a?"-":(a||(a=0),0>a&&(c=!0,a*=-1),f=a/1e3,b=Math.floor(f/3600),d=Math.floor(f%3600/60),e=(f%3600%60).toFixed(2),(c?"-":"")+(b>0?b+":":"")+(d>0||b>0?(b>0&&10>d?"0":"")+d+":":"0:")+(10>e?"0":"")+e)}}).filter("HMS_to_milliseconds",function(){return function(a){var b,c,d,e,f,g,h;for(d=a.split(":"),c=0,h=d.reverse(),b=f=0,g=h.length;g>f;b=++f)e=h[b],c+=e*Math.pow(60,b);return 1e3*c}})}.call(this);